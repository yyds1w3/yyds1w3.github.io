<script>
  /**
   * æ ¸å¿ƒé€»è¾‘ï¼š
   * 1. ç›‘å¬ astro:page-load äº‹ä»¶ï¼ˆæ”¯æŒé¦–æ¬¡åŠ è½½å’Œé¡µé¢åˆ‡æ¢ï¼‰
   * 2. æ‰¾åˆ°æ‰€æœ‰ä»£ç å— (<pre>)
   * 3. æŠŠæ­¤è„šæœ¬æ‰€åœ¨ç»„ä»¶çš„ data-copy-btn æ¨¡æ¿å…‹éš†ä¸€ä»½ï¼Œå¡å…¥ <pre> å†…éƒ¨
   * 4. ç»‘å®šå¤åˆ¶åŠŸèƒ½
   */
  document.addEventListener('astro:page-load', () => {
    // ğŸ¯ 1. ç²¾å‡†å®šä½æ‰€æœ‰ä»£ç å—
    // åŒæ—¶å…¼å®¹ Shiki (astro-code) å’Œ Tailwind Typography (.prose pre)
    const codeBlocks = document.querySelectorAll('pre.astro-code, .prose pre');

    codeBlocks.forEach((pre) => {
      // é˜²é‡å¤ï¼šå¦‚æœå·²ç»åŠ è¿‡äº†ï¼Œå°±è·³è¿‡
      if (pre.querySelector('.copy-code-btn')) return;

      // ğŸ¯ 2. å…³é”®ï¼šå¼ºåˆ¶ pre æ ‡ç­¾ç›¸å¯¹å®šä½ï¼Œä½œä¸ºæŒ‰é’®çš„å®šä½åŸºå‡†
      // æˆ‘ä»¬é€šè¿‡ JS ç›´æ¥åŠ  styleï¼Œä¿è¯ä¼˜å…ˆçº§æœ€é«˜
      (pre as HTMLElement).style.position = 'relative';

      // ğŸ¯ 3. åˆ›å»ºæŒ‰é’® DOM
      const button = document.createElement('button');
      button.className = 'copy-code-btn';
      button.type = 'button';
      button.setAttribute('aria-label', 'Copy code');
      // è¿™é‡Œä½¿ç”¨ Emoji å›¾æ ‡ï¼Œå…¼å®¹æ€§æœ€å¥½
      button.innerHTML = '<span class="btn-icon">ğŸ“„</span>';

      // ğŸ¯ 4. ç»‘å®šç‚¹å‡»äº‹ä»¶
      button.addEventListener('click', async () => {
        // è·å–çº¯æ–‡æœ¬
        const codeText = pre.querySelector('code')?.innerText || '';
        if (!codeText.trim()) return;

        try {
          await navigator.clipboard.writeText(codeText);
          
          // æˆåŠŸçŠ¶æ€åé¦ˆ
          button.classList.add('success');
          button.innerHTML = '<span class="btn-icon">âœ…</span>';

          // 2ç§’åæ¢å¤åŸçŠ¶
          setTimeout(() => {
            button.classList.remove('success');
            button.innerHTML = '<span class="btn-icon">ğŸ“„</span>';
          }, 2000);
        } catch (err) {
          console.error('Failed to copy!', err);
          button.innerHTML = 'âŒ';
        }
      });

      // ğŸ¯ 5. å°†æŒ‰é’®æ’å…¥åˆ° <pre> æ ‡ç­¾å†…éƒ¨çš„æœ€åé¢
      pre.appendChild(button);
    });
  });
</script>

